<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="shortcut icon" type="image/x-icon" href="/image/icon/algomol_transparent.png">
    <meta charset="UTF-8" />
    <title>AlgoMol - Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Paste the SAME inline CSS here -->
    <style>
        /* -----------------------------
           EXACT same CSS from original
        ------------------------------ */
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #000;
            color: #e0e0e0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background-color: #0a0f24;
            padding: 2rem;
            text-align: center;
        }

        .logo {
            width: 200px;
            margin-bottom: 1rem;
            filter: drop-shadow(0 0 20px rgba(0, 255, 127, 0.5));
            transition: all 0.3s ease-in-out;
        }

        .logo:hover {
            filter: drop-shadow(0 0 40px rgba(0, 255, 127, 1));
            transform: scale(1.05);
        }

        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: linear-gradient(145deg, #1c1c1c, #2a2a2a);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            animation: fadeIn 1s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section {
            margin-bottom: 2rem;
            padding: 2rem;
            border-radius: 10px;
            background: rgba(26, 188, 156, 0.05);
            border: 1px solid rgba(26, 188, 156, 0.2);
            transition: all 0.3s ease;
        }

        .section:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(26, 188, 156, 0.1);
        }

        h1,
        h2,
        h3 {
            color: #1abc9c;
            margin-bottom: 1.5rem;
        }

        input[type="text"],
        input[type="password"] {
            width: 100%;
            padding: 0.8rem;
            margin: 0.5rem 0;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input[type="text"]:focus,
        input[type="password"]:focus {
            outline: none;
            box-shadow: 0 0 0 2px #1abc9c;
            background: rgba(255, 255, 255, 0.15);
        }

        button {
            background: #1abc9c;
            color: #000;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 50px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.1rem;
            margin: 1rem 0;
        }

        button:hover {
            background: #16a085;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(26, 188, 156, 0.3);
        }

        .hidden {
            display: none;
        }

        #approval-warning {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid #e74c3c;
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
        }

        .home-link {
            display: inline-block;
            color: #1abc9c;
            text-decoration: none;
            margin-top: 1rem;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }

        .home-link:hover {
            color: #16a085;
            transform: translateX(5px);
        }

        footer {
            text-align: center;
            padding: 1.5rem 0;
            background-color: #1abc9c;
            color: black;
            margin-top: auto;
        }

        /* Items List / CRUD Section */
        #itemsList {
            width: 100%;
            max-width: 600px;
            margin: 2rem auto;
            padding: 0;
            list-style: none;
        }

        #itemsList li {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 0.8rem 1.5rem;
            margin: 0.8rem auto;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            transition: all 0.3s ease;
            width: 90%;
        }

        #itemsList li:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        #itemsList li span {
            flex-grow: 1;
            margin-right: 1rem;
            text-align: left;
            padding-left: 0.5rem;
        }

        .delete-btn {
            padding: 0.3rem 0.6rem;
            font-size: 0.8rem;
            background: #2c3e50;
            color: #ecf0f1;
            border: none;
            border-radius: 4px;
            margin-left: 1rem;
            transition: all 0.3s ease;
        }

        .delete-btn:hover {
            background: #c0392b;
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(192, 57, 43, 0.3);
        }

        #crud-section {
            text-align: center;
        }

        #crud-section div {
            max-width: 600px;
            margin: 0 auto;
            display: flex;
            gap: 1rem;
            justify-content: center;
            align-items: center;
        }

        #crud-section input[type="text"] {
            flex: 1;
            max-width: 400px;
        }

        .item-content {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            align-items: flex-start;
            width: 100%;
        }

        .item-main {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding-left: 0.5rem;
        }

        .item-details {
            font-size: 0.9rem;
            color: #95a5a6;
            margin-top: 0.5rem;
            border-left: 2px solid #1abc9c;
            height: 0;
            opacity: 0;
            overflow: hidden;
            transition: all 0.3s ease;
            margin-left: 0.5rem;
            padding: 0;
            text-align: left;
            width: calc(100% - 1rem);
        }

        .item-details.show {
            height: auto;
            opacity: 1;
            padding: 0.5rem 0 0.5rem 0.5rem;
        }

        .toggle-details {
            background: none;
            border: none;
            color: #1abc9c;
            cursor: pointer;
            padding: 0.2rem 0.5rem;
            margin: 0 0.5rem;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .toggle-details:hover {
            color: #16a085;
            transform: translateY(0);
            box-shadow: none;
        }

        #admin-section {
            text-align: center;
        }

        #pending-users {
            max-width: 600px;
            margin: 2rem auto;
            padding: 0;
        }

        #pending-users li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            margin: 0.8rem auto;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            text-align: left;
            width: 90%;
        }

        .approve-btn {
            padding: 0.3rem 0.6rem;
            font-size: 0.8rem;
            background: #2ecc71;
            color: white;
            border: none;
            border-radius: 4px;
            margin-left: 1rem;
            transition: all 0.3s ease;
            text-transform: none;
        }

        .approve-btn:hover {
            background: #27ae60;
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(46, 204, 113, 0.3);
        }
    </style>
</head>

<body>
    <div class="header">
        <a href="index.html">
            <img src="/image/icon/algomol_transparent.png" alt="AlgoMol Logo" class="logo">
        </a>
        <h1>Member Dashboard</h1>
    </div>

    <div class="container">
        <!-- User Section -->
        <div class="section hidden" id="user-section">
            <h2>Welcome, <span id="current-user"></span>!</h2>
            <p id="approval-warning" class="hidden">
                <i class="fas fa-exclamation-triangle"></i>
                Your account is pending approval. Please wait for an admin to approve your account.
            </p>
            <button id="btn-logout"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>

        <!-- Admin Section -->
        <div class="section hidden" id="admin-section">
            <h2><i class="fas fa-user-shield"></i> Admin Panel</h2>
            <button id="btn-load-pending"><i class="fas fa-sync"></i> Load Unapproved Users</button>
            <ul id="pending-users"></ul>
        </div>

        <!-- EXACT same "Database Access" section from your original code -->
        <div class="section hidden" id="crud-section">
            <h2><i class="fas fa-database"></i> Database Access</h2>
            <div>
                <input type="text" id="inputItem" placeholder="Add new item">
                <button id="btnCreate"><i class="fas fa-plus"></i> Create</button>
            </div>
            <button id="btnLoad"><i class="fas fa-list"></i> Load All Items</button>
            <ul id="itemsList"></ul>
        </div>

        <a href="index.html" class="home-link">
            <i class="fas fa-arrow-left"></i> Back to Home
        </a>
    </div>

    <footer>
        <p>&copy; 2024 AlgoMol LLC. All rights reserved.</p>
    </footer>

    <script src="https://unpkg.com/leancloud-storage/dist/av-min.js"></script>
    <script>
        /****************************************
         * 1. Initialize LeanCloud
         ****************************************/
        AV.init({
            appId: 'ZxhupKKmXgSXHf1uyEckW1xv-gzGzoHsz',
            appKey: '3YQM3gLlbLMBy3mmZulgwIlS',
            serverURL: 'https://zxhupkkm.lc-cn-n1-shared.com'
        });

        // DOM references
        const userSection = document.getElementById('user-section');
        const adminSection = document.getElementById('admin-section');
        const crudSection = document.getElementById('crud-section');

        const currentUserEl = document.getElementById('current-user');
        const approvalWarningEl = document.getElementById('approval-warning');
        const btnLogout = document.getElementById('btn-logout');

        // Admin
        const btnLoadPending = document.getElementById('btn-load-pending');
        const pendingUsers = document.getElementById('pending-users');

        // CRUD
        const inputItem = document.getElementById('inputItem');
        const btnCreate = document.getElementById('btnCreate');
        const btnLoad = document.getElementById('btnLoad');
        const itemsList = document.getElementById('itemsList');

        // LeanCloud class
        const ItemClass = AV.Object.extend('Item');

        /****************************************
         * 2. Check if user is logged in
         ****************************************/
        checkLoginState();

        async function checkLoginState() {
            const currentUser = AV.User.current();
            if (!currentUser) {
                // Not logged in? Return to login page
                window.location.href = 'login.html';
                return;
            }

            userSection.classList.remove('hidden');
            currentUserEl.textContent = currentUser.getUsername();

            // Admin check
            if (await isAdmin(currentUser)) {
                adminSection.classList.remove('hidden');
            } else {
                adminSection.classList.add('hidden');
            }

            // Approved check => show/hide CRUD
            if (await canUserDoCRUD(currentUser)) {
                approvalWarningEl.classList.add('hidden');
                crudSection.classList.remove('hidden');
            } else {
                approvalWarningEl.classList.remove('hidden');
                crudSection.classList.add('hidden');
            }
        }

        // Example role checks
        async function isAdmin(user) {
            if (!user) return false;
            const roles = await user.getRoles();
            return roles.some(role => role.getName() === 'Admin');
        }
        async function canUserDoCRUD(user) {
            if (!user) return false;
            const roles = await user.getRoles();
            return roles.some(role => role.getName() === 'Approved');
        }

        /****************************************
         * 3. Logout
         ****************************************/
        btnLogout.addEventListener('click', async () => {
            try {
                await AV.User.logOut();
                alert('Logged out!');
                window.location.href = 'login.html';
            } catch (err) {
                console.error('Logout error:', err);
            }
        });

        /****************************************
         * 4. Admin: Load & Approve Users
         ****************************************/
        btnLoadPending.addEventListener('click', async () => {
            const currentUser = AV.User.current();
            if (!currentUser || !(await isAdmin(currentUser))) {
                alert('Only admin can load pending users.');
                return;
            }
            try {
                // 1) Fetch all users
                const allUsersQuery = new AV.Query('_User');
                allUsersQuery.limit(1000);
                const allUsers = await allUsersQuery.find();

                // 2) Fetch Approved role
                const roleQuery = new AV.Query(AV.Role);
                roleQuery.equalTo('name', 'Approved');
                const approvedRole = await roleQuery.first();
                if (!approvedRole) {
                    alert('Could not find the "Approved" role.');
                    return;
                }

                // 3) Who is already in Approved
                const approvedUsersQuery = approvedRole.getUsers().query();
                approvedUsersQuery.limit(1000);
                const approvedUsers = await approvedUsersQuery.find();
                const approvedIds = new Set(approvedUsers.map(u => u.id));

                // 4) Subtract
                const notApproved = allUsers.filter(u => !approvedIds.has(u.id));

                // 5) Display
                pendingUsers.innerHTML = '';
                if (notApproved.length === 0) {
                    pendingUsers.innerHTML = '<li>No unapproved users found.</li>';
                    return;
                }
                notApproved.forEach(u => {
                    const li = document.createElement('li');
                    li.textContent = u.getUsername();

                    const approveBtn = document.createElement('button');
                    approveBtn.className = 'approve-btn';
                    approveBtn.textContent = 'Approve';
                    approveBtn.addEventListener('click', () => approveUser(u, li));

                    li.appendChild(approveBtn);
                    pendingUsers.appendChild(li);
                });
            } catch (err) {
                console.error('Error loading pending users:', err);
                alert(`Failed to load pending users: ${err.message}`);
            }
        });

        async function approveUser(userObj, liElement) {
            if (!confirm(`Approve user ${userObj.getUsername()}?`)) {
                return;
            }
            try {
                const roleQuery = new AV.Query(AV.Role);
                roleQuery.equalTo('name', 'Approved');
                const approvedRole = await roleQuery.first();
                if (!approvedRole) {
                    throw new Error('No "Approved" role found.');
                }
                approvedRole.getUsers().add(userObj);
                await approvedRole.save();

                if (liElement.parentNode) {
                    liElement.parentNode.removeChild(liElement);
                }
                alert(`${userObj.getUsername()} is now approved.`);
            } catch (err) {
                console.error('Approve error:', err);
                alert(`Approve failed: ${err.message}`);
            }
        }

        /****************************************
         * 5. CREATE/READ/DELETE with Toggle
         ****************************************/
        btnCreate.addEventListener('click', createItem);
        btnLoad.addEventListener('click', loadItems);

        async function createItem() {
            const currentUser = AV.User.current();
            if (!currentUser || !(await canUserDoCRUD(currentUser))) {
                alert('Not approved to create items.');
                return;
            }

            const itemName = inputItem.value.trim();
            if (!itemName) {
                alert('Please enter an item name.');
                return;
            }

            const newItem = new ItemClass();
            newItem.set('name', itemName);

            // Public read/write
            const acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newItem.setACL(acl);

            try {
                await newItem.save();
                inputItem.value = '';
                loadItems();
            } catch (err) {
                console.error('Error saving item:', err);
                alert(`Save failed: ${err.message}`);
            }
        }

        async function loadItems() {
            const currentUser = AV.User.current();
            if (!currentUser || !(await canUserDoCRUD(currentUser))) {
                alert('Not approved to load items.');
                return;
            }

            itemsList.innerHTML = '';
            const query = new AV.Query('Item');
            query.descending('createdAt');

            try {
                const results = await query.find();

                results.forEach(item => {
                    const li = document.createElement('li');

                    // Container for item content
                    const itemContent = document.createElement('div');
                    itemContent.className = 'item-content';

                    // Main row
                    const itemMain = document.createElement('div');
                    itemMain.className = 'item-main';

                    // Name
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = item.get('name');

                    // Control buttons
                    const controls = document.createElement('div');
                    controls.style.display = 'flex';
                    controls.style.alignItems = 'center';

                    // Toggle details button
                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = 'toggle-details';
                    toggleBtn.innerHTML = '<i class="fas fa-chevron-down"></i>';

                    // Delete button
                    const delBtn = document.createElement('button');
                    delBtn.textContent = 'Delete';
                    delBtn.className = 'delete-btn';
                    delBtn.addEventListener('click', () => deleteItem(item.id, li));

                    // Details section
                    const details = document.createElement('div');
                    details.className = 'item-details';
                    // Example: weight_kg field from your original code
                    const weight = item.get('weight_kg');
                    details.innerHTML = `<span style="margin-left: 0.5rem">Weight: ${weight + ' kg'}</span>`;

                    // Toggle logic
                    toggleBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const isShowing = details.classList.contains('show');
                        if (isShowing) {
                            details.classList.remove('show');
                            toggleBtn.innerHTML = '<i class="fas fa-chevron-down"></i>';
                        } else {
                            details.classList.add('show');
                            toggleBtn.innerHTML = '<i class="fas fa-chevron-up"></i>';
                        }
                    });

                    // Assemble
                    controls.appendChild(toggleBtn);
                    controls.appendChild(delBtn);
                    itemMain.appendChild(nameSpan);
                    itemMain.appendChild(controls);
                    itemContent.appendChild(itemMain);
                    itemContent.appendChild(details);
                    li.appendChild(itemContent);

                    itemsList.appendChild(li);
                });
            } catch (err) {
                console.error('Load error:', err);
                alert(`Load failed: ${err.message}`);
            }
        }

        async function deleteItem(objectId, liElement) {
            const currentUser = AV.User.current();
            if (!currentUser || !(await canUserDoCRUD(currentUser))) {
                alert('Not approved to delete items.');
                return;
            }
            if (!confirm('Are you sure you want to delete this item?')) {
                return;
            }

            const itemToDelete = AV.Object.createWithoutData('Item', objectId);
            try {
                await itemToDelete.destroy();
                if (liElement.parentNode) {
                    liElement.parentNode.removeChild(liElement);
                }
            } catch (err) {
                console.error('Delete error:', err);
                alert(`Delete failed: ${err.message}`);
            }
        }
    </script>
</body>

</html>